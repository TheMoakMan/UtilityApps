<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Tickwise ‚Äî Local Symptom Tracker</title>
  <meta name="description" content="Local-only tracker for Lyme & tick-borne illness symptoms, triggers, meds, and exports. Not medical advice." />
  <style>
    :root {
      --bg: #0b0f14;
      --panel: #121821;
      --panel-2: #0f141c;
      --text: #e6eef6;
      --muted: #a7b3c2;
      --accent: #5dd0ff;
      --accent-2: #9bffb4;
      --danger: #ff6b6b;
      --ok: #38d89b;
      --warn: #ffd166;
      --border: #223147;
      --shadow: rgba(0,0,0,0.4);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 24px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b0f14, #0a111a 20%, #0b0f14 100%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    }
    header {
      position: sticky; top: 0; z-index: 10;
      background: rgba(11,15,20,0.7);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }
    header .brand {
      display: flex; gap: 10px; align-items: center;
    }
    .logo {
      width: 34px; height: 34px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #a8ff78, #78ffd6 60%, #58cced 100%);
      box-shadow: 0 4px 16px var(--shadow), inset 0 0 10px rgba(255,255,255,0.2);
      position: relative;
      overflow: hidden;
    }
    .logo::after {
      content: "ü¶ü";
      position: absolute; inset: 0;
      display: grid; place-items: center;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,0.4));
      font-size: 20px;
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .subtitle { color: var(--muted); font-size: 12px; }

    main {
      padding: 16px;
      padding-bottom: 88px; /* keep space for tabbar */
      max-width: 900px;
      margin: 0 auto;
    }

    .card {
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 10px 24px var(--shadow);
      margin-bottom: 16px;
    }

    h2 { font-size: 18px; margin: 0 0 10px; }
    h3 { font-size: 16px; margin: 12px 0 8px; color: var(--muted); }

    label { display: block; font-size: 14px; margin: 8px 0 6px; color: var(--muted); }
    input[type="text"],
    input[type="datetime-local"],
    input[type="time"],
    textarea,
    select {
      width: 100%;
      background: #0c121a;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
      outline: none;
    }
    textarea { min-height: 80px; resize: vertical; border-radius: var(--radius); }

    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .row-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
    @media (max-width: 560px) {
      .row, .row-3, .row-4 { grid-template-columns: 1fr; }
    }

    .slider-wrap { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    input[type="range"] { width: 100%; }

    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: #101722;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      margin: 6px 6px 0 0;
    }
    .chip input { accent-color: var(--accent); }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    button {
      background: linear-gradient(180deg, #1a2433, #141d2a);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 600;
      letter-spacing: 0.2px;
      box-shadow: 0 6px 16px var(--shadow);
      cursor: pointer;
    }
    button.primary { background: linear-gradient(180deg, #16a8ff, #1185d4); border-color: #0f7ec9; }
    button.ghost { background: transparent; border-color: var(--border); }
    button.warn { background: linear-gradient(180deg, #ffb703, #e09f00); border-color: #c88a00; }
    button.danger { background: linear-gradient(180deg, #ef476f, #d11d49); border-color: #b4163b; }
    button:disabled { opacity: 0.6; }

    .list { display: grid; gap: 10px; }
    .list-item {
      display: grid; gap: 6px;
      background: #0d1420;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px;
    }
    .muted { color: var(--muted); }
    .small { font-size: 12px; }
    .right { text-align: right; }

    /* Calendar */
    .calendar {
      display: grid;
      gap: 10px;
    }
    .cal-header { display: flex; justify-content: space-between; align-items: center; }
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    .cal-cell {
      position: relative;
      min-height: 62px;
      background: #0d1420;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
      overflow: hidden;
    }
    .cal-cell .date { font-size: 12px; color: var(--muted); }
    .cal-cell .heat { position: absolute; inset: 0; border-radius: 9px; opacity: 0.35; }
    .cal-legend { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

    /* Tab bar */
    nav.tabbar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 20;
      background: rgba(13,20,32,0.9); backdrop-filter: blur(8px);
      border-top: 1px solid var(--border);
      display: grid; grid-template-columns: repeat(5, 1fr);
    }
    .tab {
      padding: 10px 6px;
      display: grid; place-items: center;
      gap: 4px;
      color: var(--muted);
      font-size: 12px;
    }
    .tab.active { color: var(--text); }
    .tab .ico { font-size: 18px; }

    .notice {
      font-size: 12px;
      color: var(--muted);
      background: #0d1420;
      border: 1px dashed var(--border);
      padding: 10px;
      border-radius: 12px;
    }

    .hr { height: 1px; background: var(--border); margin: 10px 0; border-radius: 1px; }

    .kbd {
      background: #0b111a; border: 1px solid var(--border); border-radius: 6px;
      padding: 1px 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .pill {
      padding: 4px 8px; border-radius: 999px; font-size: 11px; border: 1px solid var(--border);
    }

    .link { color: var(--accent); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Tickwise</div>
        <div class="subtitle">Local-only tracker (offline friendly)</div>
      </div>
    </div>
    <div>
      <button class="ghost small" id="btnShare">Share</button>
    </div>
  </header>

  <main>
    <!-- LOG TAB -->
    <section id="tab-log" class="tabpane">
      <div class="card">
        <h2>Log symptoms</h2>
        <div class="row">
          <div>
            <label for="dt">Date & time</label>
            <input id="dt" type="datetime-local" />
          </div>
          <div>
            <label for="mood">Overall day rating</label>
            <select id="mood">
              <option value="">‚Äî</option>
              <option value="good">Good</option>
              <option value="ok">OK</option>
              <option value="bad">Bad</option>
              <option value="flare">Flare</option>
            </select>
          </div>
        </div>

        <h3>Symptoms (0‚Äì10)</h3>
        <div class="row">
          <div class="slider-wrap"><label>Fatigue</label><input id="fatigue" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="fatigueVal">0</span></div>
          <div class="slider-wrap"><label>Pain</label><input id="pain" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="painVal">0</span></div>
        </div>
        <div class="row">
          <div class="slider-wrap"><label>Brain fog</label><input id="brainfog" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="brainfogVal">0</span></div>
          <div class="slider-wrap"><label>Headache</label><input id="headache" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="headacheVal">0</span></div>
        </div>
        <div class="row">
          <div class="slider-wrap"><label>Joint issues</label><input id="joints" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="jointsVal">0</span></div>
          <div class="slider-wrap"><label>Heart palpitations</label><input id="palps" type="range" min="0" max="10" step="1" value="0" oninput="showVal(this)"><span id="palpsVal">0</span></div>
        </div>

        <h3>Triggers (optional)</h3>
        <div class="triggers">
          <label class="chip"><input type="checkbox" id="tr_dairy"/> Dairy</label>
          <label class="chip"><input type="checkbox" id="tr_sugar"/> Sugar/high-carb</label>
          <label class="chip"><input type="checkbox" id="tr_alcohol"/> Alcohol</label>
          <label class="chip"><input type="checkbox" id="tr_histamine"/> High-histamine foods</label>
          <label class="chip"><input type="checkbox" id="tr_stress"/> Stress</label>
          <label class="chip"><input type="checkbox" id="tr_exertion"/> Overexertion</label>
          <label class="chip"><input type="checkbox" id="tr_sleep"/> Poor sleep</label>
          <label class="chip"><input type="checkbox" id="tr_weather"/> Weather front</label>
          <label class="chip"><input type="checkbox" id="tr_bite"/> Recent tick bite</label>
        </div>
        <label for="otherTrig">Other triggers/foods</label>
        <input id="otherTrig" type="text" placeholder="e.g., shellfish, aged cheese, long workout, etc." />

        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Anything else you want to remember‚Ä¶"></textarea>

        <div class="actions">
          <button class="primary" id="saveEntry">Save entry</button>
          <button class="ghost" id="clearForm">Clear</button>
        </div>
        <div class="notice" style="margin-top:10px;">
          This app stores everything <b>locally on your device</b> (no cloud). It is for tracking and personal organization only and is <b>not medical advice</b>.
        </div>
      </div>

      <div class="card">
        <h2>Recent entries</h2>
        <div id="recentList" class="list"></div>
      </div>
    </section>

    <!-- CALENDAR TAB -->
    <section id="tab-calendar" class="tabpane" hidden>
      <div class="card">
        <div class="calendar">
          <div class="cal-header">
            <button id="prevMonth">&larr;</button>
            <div><strong id="calMonthLabel"></strong></div>
            <button id="nextMonth">&rarr;</button>
          </div>
          <div class="cal-grid" id="calGrid"></div>
          <div class="cal-legend">
            <span class="small muted">Heat = average symptom severity (darker = worse)</span>
          </div>
        </div>
      </div>
      <div class="card">
        <h2>Day details</h2>
        <div id="dayDetails" class="list"></div>
      </div>
    </section>

    <!-- ANALYTICS TAB -->
    <section id="tab-analytics" class="tabpane" hidden>
      <div class="card">
        <h2>Overview</h2>
        <div id="statsOverview" class="list"></div>
      </div>

      <div class="card">
        <h2>Trigger correlations (experimental)</h2>
        <div class="notice">This looks for simple relationships between triggers (checked vs not) and daily average severity.<br/>It is basic math, not medical guidance.</div>
        <div id="corrList" class="list" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- PROTOCOL TAB (Meds & Supplements) -->
    <section id="tab-protocol" class="tabpane" hidden>
      <div class="card">
        <h2>Medication & supplements</h2>
        <div class="row">
          <div><label>Name</label><input id="medName" type="text" placeholder="e.g., Doxycycline, Magnesium, etc." /></div>
          <div><label>Dosage/notes</label><input id="medDose" type="text" placeholder="e.g., 100 mg, 2 caps" /></div>
        </div>
        <div class="row">
          <div><label>Time 1</label><input id="medT1" type="time" /></div>
          <div><label>Time 2</label><input id="medT2" type="time" /></div>
        </div>
        <div class="actions">
          <button class="primary" id="addMed">Add to list</button>
          <button class="ghost" id="clearMed">Clear</button>
        </div>
      </div>

      <div class="card">
        <h2>Today‚Äôs checklist</h2>
        <div id="todayChecklist" class="list"></div>
      </div>

      <div class="card">
        <h2>Saved items</h2>
        <div id="medList" class="list"></div>
      </div>
    </section>

    <!-- EXPORT TAB -->
    <section id="tab-export" class="tabpane" hidden>
      <div class="card">
        <h2>Export / Import</h2>
        <div class="actions">
          <button id="btnExportCSV">Export entries CSV</button>
          <button id="btnBackupJSON">Backup all (JSON)</button>
          <label class="chip" style="cursor:pointer;">
            <input type="file" id="importFile" accept=".json,.csv" style="display:none;"/>
            <span>Import‚Ä¶</span>
          </label>
        </div>
        <div class="notice" style="margin-top:10px;">
          CSV is great for spreadsheets. JSON backup includes all app data (entries, meds, checklist ticks, and links). Importing JSON will merge with your existing data.
        </div>
      </div>

      <div class="card">
        <h2>Affiliate/Resource links (your own list)</h2>
        <div class="row">
          <div><label>Label</label><input id="linkLabel" type="text" placeholder="e.g., Herbal tincture store"/></div>
          <div><label>URL</label><input id="linkUrl" type="text" placeholder="https://example.com/your-affiliate-id"/></div>
        </div>
        <div class="actions">
          <button class="primary" id="addLink">Add link</button>
          <button class="ghost" id="clearLink">Clear</button>
        </div>
        <div id="linkList" class="list" style="margin-top:10px;"></div>
        <div class="notice">
          Add your own resource or affiliate links here. These are simple bookmarks you control.
          Avoid making medical claims; consult a clinician for care decisions.
        </div>
      </div>

      <div class="card">
        <h2>Reset</h2>
        <div class="actions">
          <button class="danger" id="btnReset">Erase all local data</button>
        </div>
        <div class="notice">This deletes all local storage for Tickwise on this browser only.</div>
      </div>
    </section>
  </main>

  <nav class="tabbar">
    <div class="tab active" data-tab="log"><div class="ico">üìù</div><div>Log</div></div>
    <div class="tab" data-tab="calendar"><div class="ico">üìÜ</div><div>Calendar</div></div>
    <div class="tab" data-tab="analytics"><div class="ico">üìä</div><div>Analytics</div></div>
    <div class="tab" data-tab="protocol"><div class="ico">üíä</div><div>Protocol</div></div>
    <div class="tab" data-tab="export"><div class="ico">‚§¥Ô∏è</div><div>Export</div></div>
  </nav>

  <script>
    // --- Utilities & Storage ---
    const ls = {
      get(k, d) { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
      set(k, v) { localStorage.setItem(k, JSON.stringify(v)); },
      del(k) { localStorage.removeItem(k); }
    };
    const DB = {
      entries: "tickwise_entries",
      meds: "tickwise_meds",
      doses: "tickwise_doses", // logs of taken doses by date
      links: "tickwise_links"
    };
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const fmtDate = (iso) => {
      const d = new Date(iso);
      return d.toLocaleString();
    };
    const todayISO = () => {
      const d = new Date();
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off*60000);
      return local.toISOString().slice(0,16);
    };
    const ymd = (date) => {
      const d = new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    };
    const avg = (arr) => arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0;
    const clamp = (v, mi, ma) => Math.max(mi, Math.min(ma, v));

    function showVal(slider) {
      const id = slider.id + "Val";
      const el = document.getElementById(id);
      if (el) el.textContent = slider.value;
    }

    // --- Tabs ---
    $$(".tab").forEach(tab => tab.addEventListener("click", () => {
      const target = tab.dataset.tab;
      $$(".tab").forEach(t => t.classList.remove("active"));
      tab.classList.add("active");
      $$(".tabpane").forEach(p => p.hidden = true);
      $("#tab-"+target).hidden = false;
      if (target === "calendar") renderCalendar();
      if (target === "analytics") renderAnalytics();
      if (target === "protocol") { renderTodayChecklist(); renderMeds(); }
      if (target === "export") { renderLinks(); }
      if (target === "log") { renderRecent(); }
    }));

    // --- Initialize form defaults ---
    $("#dt").value = todayISO();

    // --- Save entry ---
    $("#saveEntry").addEventListener("click", () => {
      const dt = $("#dt").value || todayISO();
      const entry = {
        id: crypto.randomUUID?.() ?? String(Date.now()),
        dt,
        mood: $("#mood").value || "",
        symptoms: {
          fatigue: +$("#fatigue").value,
          pain: +$("#pain").value,
          brainfog: +$("#brainfog").value,
          headache: +$("#headache").value,
          joints: +$("#joints").value,
          palps: +$("#palps").value
        },
        triggers: {
          dairy: $("#tr_dairy").checked,
          sugar: $("#tr_sugar").checked,
          alcohol: $("#tr_alcohol").checked,
          histamine: $("#tr_histamine").checked,
          stress: $("#tr_stress").checked,
          exertion: $("#tr_exertion").checked,
          sleep: $("#tr_sleep").checked,
          weather: $("#tr_weather").checked,
          bite: $("#tr_bite").checked,
          other: ($("#otherTrig").value || "").trim()
        },
        notes: ($("#notes").value || "").trim()
      };
      const list = ls.get(DB.entries, []);
      list.push(entry);
      ls.set(DB.entries, list);
      clearLogForm();
      renderRecent();
      alert("Saved!");
    });

    function clearLogForm() {
      $("#dt").value = todayISO();
      $("#mood").value = "";
      ["fatigue","pain","brainfog","headache","joints","palps"].forEach(id => {
        $("#"+id).value = 0; showVal($("#"+id));
      });
      $$(".triggers input[type=checkbox]").forEach(c => c.checked = false);
      $("#otherTrig").value = "";
      $("#notes").value = "";
    }
    $("#clearForm").addEventListener("click", clearLogForm);

    function renderRecent() {
      const box = $("#recentList");
      const list = ls.get(DB.entries, []).slice().reverse().slice(0, 15);
      if (!list.length) { box.innerHTML = `<div class="muted small">No entries yet.</div>`; return; }
      box.innerHTML = "";
      for (const e of list) {
        const s = e.symptoms;
        const sev = avg(Object.values(s));
        const trigList = Object.entries(e.triggers).filter(([k,v]) => v===true).map(([k]) => k).join(", ");
        const other = (e.triggers.other||"").trim();
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div><b>${new Date(e.dt).toLocaleString()}</b> <span class="pill">${e.mood||"‚Äî"}</span></div>
          <div class="small muted">Avg severity: ${sev.toFixed(1)} &nbsp;|&nbsp; fatigue ${s.fatigue}, pain ${s.pain}, brainfog ${s.brainfog}</div>
          ${trigList || other ? `<div class="small">Triggers: ${(trigList + (other? (trigList?", ":"")+other : "")).trim()}</div>` : ""}
          ${e.notes ? `<div class="small">${escapeHtml(e.notes)}</div>` : ""}
          <div class="actions" style="justify-content:flex-end;">
            <button class="ghost small" data-edit="${e.id}">Edit</button>
            <button class="ghost small" data-del="${e.id}">Delete</button>
          </div>
        `;
        box.appendChild(div);
      }
      // Bind edit/delete
      $$("#recentList [data-del]").forEach(btn => btn.addEventListener("click", () => {
        if (!confirm("Delete this entry?")) return;
        const id = btn.getAttribute("data-del");
        const arr = ls.get(DB.entries, []);
        ls.set(DB.entries, arr.filter(x => x.id !== id));
        renderRecent(); renderCalendar(); renderAnalytics();
      }));
      $$("#recentList [data-edit]").forEach(btn => btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-edit");
        const arr = ls.get(DB.entries, []);
        const e = arr.find(x => x.id === id);
        if (!e) return;
        $("#dt").value = e.dt.slice(0,16);
        $("#mood").value = e.mood || "";
        for (const k in e.symptoms) { $("#"+k).value = e.symptoms[k]; showVal($("#"+k)); }
        for (const k of ["dairy","sugar","alcohol","histamine","stress","exertion","sleep","weather","bite"]) {
          $("#tr_"+k).checked = !!e.triggers[k];
        }
        $("#otherTrig").value = e.triggers.other || "";
        $("#notes").value = e.notes || "";
        // delete old and let user save as new
        ls.set(DB.entries, arr.filter(x => x.id !== id));
        $$(".tab").find(t => t.dataset.tab==="log").click();
        window.scrollTo({top: 0, behavior: "smooth"});
      }));
    }

    function escapeHtml(str="") {
      return str.replace(/[&<>"']/g, m => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }

    // --- Calendar ---
    let calYear, calMonth; // month = 0..11
    function initCalToToday() {
      const d = new Date();
      calYear = d.getFullYear();
      calMonth = d.getMonth();
    }
    function renderCalendar() {
      if (calYear==null) initCalToToday();
      $("#calMonthLabel").textContent = new Date(calYear, calMonth, 1).toLocaleString(undefined, {month:"long", year:"numeric"});
      const grid = $("#calGrid");
      grid.innerHTML = "";
      const firstDay = new Date(calYear, calMonth, 1);
      const startWeekday = (firstDay.getDay()+6)%7; // make Monday=0
      const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
      const entries = ls.get(DB.entries, []);
      // Map daily avg
      const map = {};
      for (const e of entries) {
        const d = ymd(e.dt);
        const sev = avg(Object.values(e.symptoms));
        if (!map[d]) map[d]=[];
        map[d].push(sev);
      }
      for (let i=0;i<startWeekday;i++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        cell.style.visibility = "hidden";
        grid.appendChild(cell);
      }
      for (let day=1; day<=daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.className = "cal-cell";
        const dateStr = `${calYear}-${String(calMonth+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
        const dayAvg = map[dateStr] ? avg(map[dateStr]) : 0;
        const hue = 200 - clamp(dayAvg*20, 0, 140); // 200 (cool) -> 60 (warm)
        const heat = `linear-gradient(180deg, hsla(${hue},85%,55%,0.65), hsla(${hue},85%,45%,0.65))`;
        cell.innerHTML = `
          <div class="date">${day}</div>
          <div class="heat" style="background:${dayAvg ? heat : 'transparent'}"></div>
        `;
        cell.addEventListener("click", () => openDay(dateStr));
        grid.appendChild(cell);
      }
    }
    $("#prevMonth").addEventListener("click", ()=>{ calMonth--; if (calMonth<0){calMonth=11; calYear--;} renderCalendar(); });
    $("#nextMonth").addEventListener("click", ()=>{ calMonth++; if (calMonth>11){calMonth=0; calYear++;} renderCalendar(); });

    function openDay(dateStr) {
      const list = ls.get(DB.entries, []).filter(e => ymd(e.dt) === dateStr).sort((a,b)=>a.dt.localeCompare(b.dt));
      const box = $("#dayDetails");
      box.innerHTML = "";
      const h = document.createElement("div");
      h.className = "muted";
      h.textContent = new Date(dateStr+"T00:00").toLocaleDateString(undefined, {weekday:"long", year:"numeric", month:"short", day:"numeric"});
      box.appendChild(h);
      if (!list.length) {
        const d = document.createElement("div");
        d.className = "muted small";
        d.textContent = "No entries for this day.";
        box.appendChild(d);
        return;
      }
      for (const e of list) {
        const s = e.symptoms;
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div><b>${new Date(e.dt).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})}</b> <span class="pill">${e.mood||"‚Äî"}</span></div>
          <div class="small muted">fatigue ${s.fatigue}, pain ${s.pain}, brainfog ${s.brainfog}, headache ${s.headache}, joints ${s.joints}, palps ${s.palps}</div>
          ${e.triggers.other ? `<div class="small">Other: ${escapeHtml(e.triggers.other)}</div>`:""}
          ${e.notes ? `<div class="small">${escapeHtml(e.notes)}</div>`:""}
        `;
        box.appendChild(div);
      }
    }

    // --- Analytics ---
    function renderAnalytics() {
      const entries = ls.get(DB.entries, []);
      const byDay = {};
      for (const e of entries) {
        const d = ymd(e.dt);
        if (!byDay[d]) byDay[d] = [];
        byDay[d].push(e);
      }
      // Overview stats
      const days = Object.keys(byDay).sort();
      const dailyAvg = days.map(d => avg(byDay[d].map(e => avg(Object.values(e.symptoms)))));
      const overall = avg(dailyAvg);
      const statsBox = $("#statsOverview");
      statsBox.innerHTML = `
        <div class="list-item">
          <div><b>Tracked days:</b> ${days.length}</div>
          <div><b>Avg daily severity:</b> ${overall ? overall.toFixed(2) : "‚Äî"}</div>
        </div>
      `;
      // per-symptom averages
      const symKeys = ["fatigue","pain","brainfog","headache","joints","palps"];
      const perSym = {};
      symKeys.forEach(k => perSym[k] = avg(entries.map(e => e.symptoms[k])));
      const perSymDiv = document.createElement("div");
      perSymDiv.className = "list-item";
      perSymDiv.innerHTML = `<div><b>Avg symptom severities</b></div>` + symKeys.map(k => `<div class="small">${k}: ${perSym[k] ? perSym[k].toFixed(2) : "‚Äî"}</div>`).join("");
      statsBox.appendChild(perSymDiv);

      // Trigger correlations
      const corrBox = $("#corrList");
      corrBox.innerHTML = "";
      const trigKeys = ["dairy","sugar","alcohol","histamine","stress","exertion","sleep","weather","bite"];
      // Build daily presence vectors (1 if any entry that day has trigger on)
      const dayTrig = days.map(d => {
        const o = {};
        for (const t of trigKeys) o[t] = byDay[d].some(e => !!e.triggers[t]) ? 1 : 0;
        return o;
      });
      // Daily avg severity
      const y = days.map((d,i)=> dailyAvg[i]);
      // Correlation helper
      function pearson(x, y) {
        const n = x.length;
        if (!n) return 0;
        const mx = avg(x), my = avg(y);
        let num=0, dx=0, dy=0;
        for (let i=0;i<n;i++) {
          const a=x[i]-mx, b=y[i]-my;
          num += a*b; dx += a*a; dy += b*b;
        }
        const den = Math.sqrt(dx*dy);
        return den ? num/den : 0;
      }
      const rows = [];
      for (const t of trigKeys) {
        const x = dayTrig.map(d => d[t]);
        const r = pearson(x, y);
        rows.push({trigger:t, r});
      }
      rows.sort((a,b)=>Math.abs(b.r)-Math.abs(a.r));
      if (!rows.length || days.length < 3) {
        corrBox.innerHTML = `<div class="muted small">Not enough data yet.</div>`;
      } else {
        for (const r of rows) {
          const tag = r.r >= 0 ? "positive" : "negative";
          const pillColor = r.r >= 0 ? "warn" : "ok";
          const div = document.createElement("div");
          div.className = "list-item";
          div.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div><b>${r.trigger}</b></div>
              <div class="pill">${r.r.toFixed(3)} ${r.r>=0? "‚Üë" : "‚Üì"}</div>
            </div>
            <div class="small muted">Correlation of trigger presence with average daily severity.</div>
          `;
          corrBox.appendChild(div);
        }
      }
    }

    // --- Protocol (Meds & Supplements) ---
    $("#addMed").addEventListener("click", () => {
      const name = ($("#medName").value || "").trim();
      const dose = ($("#medDose").value || "").trim();
      const t1 = $("#medT1").value || "";
      const t2 = $("#medT2").value || "";
      if (!name) { alert("Name is required"); return; }
      const list = ls.get(DB.meds, []);
      list.push({ id: crypto.randomUUID?.() ?? String(Date.now()), name, dose, times: [t1,t2].filter(Boolean), active: true });
      ls.set(DB.meds, list);
      $("#medName").value = ""; $("#medDose").value = ""; $("#medT1").value = ""; $("#medT2").value = "";
      renderMeds(); renderTodayChecklist();
    });
    $("#clearMed").addEventListener("click", () => {
      $("#medName").value = ""; $("#medDose").value = ""; $("#medT1").value = ""; $("#medT2").value = "";
    });

    function renderMeds() {
      const box = $("#medList"); box.innerHTML = "";
      const list = ls.get(DB.meds, []);
      if (!list.length) { box.innerHTML = `<div class="muted small">No items yet.</div>`; return; }
      for (const m of list) {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div><b>${escapeHtml(m.name)}</b> <span class="muted small">${escapeHtml(m.dose||"")}</span></div>
            <div><label class="chip"><input type="checkbox" ${m.active? "checked":""} data-toggle="${m.id}" /> Active</label></div>
          </div>
          <div class="small muted">Times: ${m.times?.join(", ") || "‚Äî"}</div>
          <div class="actions" style="justify-content:flex-end;">
            <button class="ghost small" data-rem="${m.id}">Remove</button>
          </div>
        `;
        box.appendChild(div);
      }
      $$("#medList [data-rem]").forEach(btn => btn.addEventListener("click", () => {
        if (!confirm("Remove this item?")) return;
        const id = btn.getAttribute("data-rem");
        ls.set(DB.meds, ls.get(DB.meds, []).filter(x => x.id !== id));
        renderMeds(); renderTodayChecklist();
      }));
      $$("#medList [data-toggle]").forEach(ch => ch.addEventListener("change", () => {
        const id = ch.getAttribute("data-toggle");
        const arr = ls.get(DB.meds, []);
        const m = arr.find(x => x.id === id);
        if (m){ m.active = ch.checked; ls.set(DB.meds, arr); renderTodayChecklist(); }
      }));
    }

    function renderTodayChecklist() {
      const box = $("#todayChecklist"); box.innerHTML = "";
      const meds = ls.get(DB.meds, []).filter(m => m.active);
      if (!meds.length) { box.innerHTML = `<div class="muted small">No active items.</div>`; return; }
      const today = ymd(new Date());
      const doses = ls.get(DB.doses, {});
      if (!doses[today]) doses[today] = {};
      for (const m of meds) {
        const times = m.times?.length ? m.times : ["08:00"];
        for (const t of times) {
          const key = `${m.id}@${t}`;
          const taken = !!doses[today][key];
          const div = document.createElement("div");
          div.className = "list-item";
          div.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div><b>${escapeHtml(m.name)}</b> <span class="muted small">${escapeHtml(m.dose||"")}</span></div>
              <div>
                <label class="chip"><input type="checkbox" ${taken? "checked":""} data-dose="${key}"/> Taken at ${t}</label>
              </div>
            </div>
          `;
          box.appendChild(div);
        }
      }
      // bind
      $$("#todayChecklist [data-dose]").forEach(ch => ch.addEventListener("change", () => {
        const key = ch.getAttribute("data-dose");
        const state = ch.checked;
        const today = ymd(new Date());
        const doses = ls.get(DB.doses, {});
        if (!doses[today]) doses[today] = {};
        doses[today][key] = state;
        ls.set(DB.doses, doses);
      }));
    }

    // --- Export / Import ---
    function download(filename, text, mime="text/plain") {
      const blob = new Blob([text], {type: mime});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename; document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    $("#btnExportCSV").addEventListener("click", () => {
      const entries = ls.get(DB.entries, []);
      const head = ["dt","mood","fatigue","pain","brainfog","headache","joints","palps","dairy","sugar","alcohol","histamine","stress","exertion","sleep","weather","bite","other","notes"];
      const rows = [head.join(",")];
      for (const e of entries) {
        const s = e.symptoms, t = e.triggers;
        const row = [
          e.dt,
          csv(e.mood),
          s.fatigue, s.pain, s.brainfog, s.headache, s.joints, s.palps,
          t.dairy?1:0, t.sugar?1:0, t.alcohol?1:0, t.histamine?1:0, t.stress?1:0, t.exertion?1:0, t.sleep?1:0, t.weather?1:0, t.bite?1:0,
          csv(t.other||""),
          csv(e.notes||"")
        ].join(",");
        rows.push(row);
      }
      download("tickwise_entries.csv", rows.join("\n"), "text/csv");
    });

    function csv(v) {
      const s = String(v ?? "");
      if (s.includes(",") || s.includes("\"") || s.includes("\n")) {
        return "\"" + s.replace(/"/g, '""') + "\"";
      }
      return s;
    }

    $("#btnBackupJSON").addEventListener("click", () => {
      const payload = {
        entries: ls.get(DB.entries, []),
        meds: ls.get(DB.meds, []),
        doses: ls.get(DB.doses, {}),
        links: ls.get(DB.links, []),
        meta: { app: "tickwise", version: 1, exportedAt: new Date().toISOString() }
      };
      download("tickwise_backup.json", JSON.stringify(payload, null, 2), "application/json");
    });

    $("#importFile").addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          if (file.name.endsWith(".json")) {
            const data = JSON.parse(reader.result);
            if (data.entries) ls.set(DB.entries, mergeArrays(ls.get(DB.entries, []), data.entries));
            if (data.meds) ls.set(DB.meds, mergeArrays(ls.get(DB.meds, []), data.meds));
            if (data.doses) ls.set(DB.doses, {...ls.get(DB.doses, {}), ...data.doses});
            if (data.links) ls.set(DB.links, mergeArrays(ls.get(DB.links, []), data.links));
            alert("Import complete!");
            renderRecent(); renderCalendar(); renderAnalytics(); renderMeds(); renderTodayChecklist(); renderLinks();
          } else if (file.name.endsWith(".csv")) {
            // minimal CSV import for entries
            const txt = String(reader.result);
            const lines = txt.split(/\r?\n/).filter(Boolean);
            const head = lines.shift().split(",");
            const rows = lines.map(line => parseCsvLine(line));
            const curr = ls.get(DB.entries, []);
            for (const r of rows) {
              const obj = {};
              head.forEach((h, i) => obj[h] = r[i]);
              // cast
              const entry = {
                id: crypto.randomUUID?.() ?? String(Date.now()+Math.random()),
                dt: obj.dt,
                mood: obj.mood || "",
                symptoms: {
                  fatigue: +obj.fatigue||0, pain:+obj.pain||0, brainfog:+obj.brainfog||0, headache:+obj.headache||0, joints:+obj.joints||0, palps:+obj.palps||0
                },
                triggers: {
                  dairy: obj.dairy=="1", sugar: obj.sugar=="1", alcohol: obj.alcohol=="1", histamine: obj.histamine=="1",
                  stress: obj.stress=="1", exertion: obj.exertion=="1", sleep: obj.sleep=="1", weather: obj.weather=="1", bite: obj.bite=="1",
                  other: obj.other || ""
                },
                notes: obj.notes || ""
              };
              curr.push(entry);
            }
            ls.set(DB.entries, curr);
            alert("CSV imported!");
            renderRecent(); renderCalendar(); renderAnalytics();
          } else {
            alert("Unsupported file type.");
          }
        } catch (err) {
          console.error(err);
          alert("Import failed. Check the file format.");
        }
        e.target.value = "";
      };
      reader.readAsText(file);
    });

    function parseCsvLine(line) {
      const res = [];
      let cur = "", inQ = false;
      for (let i=0;i<line.length;i++) {
        const ch = line[i];
        if (inQ) {
          if (ch === '"' && line[i+1] === '"') { cur+='"'; i++; }
          else if (ch === '"') { inQ = false; }
          else { cur += ch; }
        } else {
          if (ch === ',') { res.push(cur); cur = ""; }
          else if (ch === '"') { inQ = true; }
          else { cur += ch; }
        }
      }
      res.push(cur);
      return res;
    }
    function mergeArrays(a, b) {
      const seen = new Set(a.map(x => x.id));
      const out = a.slice();
      for (const x of b) {
        if (!x.id || seen.has(x.id)) { x.id = crypto.randomUUID?.() ?? String(Date.now()+Math.random()); }
        seen.add(x.id);
        out.push(x);
      }
      return out;
    }

    // --- Links (affiliate/resources) ---
    $("#addLink").addEventListener("click", () => {
      const label = ($("#linkLabel").value||"").trim();
      const url = ($("#linkUrl").value||"").trim();
      if (!label || !url) { alert("Both label and URL are required"); return; }
      const arr = ls.get(DB.links, []);
      arr.push({ id: crypto.randomUUID?.() ?? String(Date.now()), label, url });
      ls.set(DB.links, arr);
      $("#linkLabel").value = ""; $("#linkUrl").value = "";
      renderLinks();
    });
    $("#clearLink").addEventListener("click", () => { $("#linkLabel").value=""; $("#linkUrl").value=""; });

    function renderLinks() {
      const arr = ls.get(DB.links, []);
      const box = $("#linkList"); box.innerHTML = "";
      if (!arr.length) { box.innerHTML = `<div class="muted small">No links yet. Add your resources or affiliate URLs.</div>`; return; }
      for (const l of arr) {
        const div = document.createElement("div");
        div.className = "list-item";
        div.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div><b>${escapeHtml(l.label)}</b><div class="small muted">${escapeHtml(l.url)}</div></div>
            <div class="actions" style="gap:6px;">
              <a class="link small" href="${escapeAttr(l.url)}" target="_blank" rel="noopener">Open</a>
              <button class="ghost small" data-del-link="${l.id}">Delete</button>
            </div>
          </div>
        `;
        box.appendChild(div);
      }
      $$("#linkList [data-del-link]").forEach(btn => btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-del-link");
        ls.set(DB.links, ls.get(DB.links, []).filter(x => x.id !== id));
        renderLinks();
      }));
    }
    function escapeAttr(s="") {
      return s.replace(/"/g, "&quot;").replace(/</g, "&lt;");
    }

    // --- Share button ---
    $("#btnShare").addEventListener("click", async () => {
      const text = "Tickwise ‚Äî local symptom tracker (single-file web app). I‚Äôm tracking my tick-borne illness symptoms and triggers offline.";
      if (navigator.share) {
        try { await navigator.share({ title: "Tickwise", text }); }
        catch(e) { /* dismissed */ }
      } else {
        try {
          await navigator.clipboard.writeText(text);
          alert("Copied info to clipboard!");
        } catch {
          alert("Share not supported. Copy this:\n\n" + text);
        }
      }
    });

    // --- Reset ---
    $("#btnReset").addEventListener("click", () => {
      if (!confirm("Erase ALL local Tickwise data on this browser?")) return;
      [DB.entries, DB.meds, DB.doses, DB.links].forEach(k => ls.del(k));
      renderRecent(); renderCalendar(); renderAnalytics(); renderMeds(); renderTodayChecklist(); renderLinks();
      alert("All local data erased.");
    });

    // --- Boot ---
    renderRecent(); initCalToToday();

    // Load demo data option if empty
    if (!ls.get(DB.entries, []).length) {
      const demo = confirm("Load a few demo entries so you can see how it works?");
      if (demo) {
        const now = new Date();
        const sample = [];
        function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate()+n); return x; }
        for (let i=-6;i<=0;i++) {
          const d = addDays(now, i);
          const dt = new Date(d.getTime()); dt.setHours(8, 30, 0, 0);
          const obj = (fatigue, pain, brainfog, headache, joints, palps, sugar, stress, exertion, sleep) => ({
            id: crypto.randomUUID?.() ?? String(Date.now()+Math.random()),
            dt: toLocalISO(dt),
            mood: (fatigue+ pain) > 10 ? "flare" : "ok",
            symptoms: { fatigue, pain, brainfog, headache, joints, palps },
            triggers: { dairy:false, sugar, alcohol:false, histamine:false, stress, exertion, sleep, weather:i%3===0, bite:false, other:"" },
            notes: i%2? "Light walk today." : "Resting more."
          });
          // vary severities
          sample.push(obj(rand(2,6), rand(1,5), rand(2,7), rand(0,4), rand(1,6), rand(0,3), Math.random()<0.4, Math.random()<0.5, Math.random()<0.3, Math.random()<0.4));
        }
        ls.set(DB.entries, sample);
        renderRecent(); renderCalendar(); renderAnalytics();
      }
    }

    function toLocalISO(d) {
      const tz = d.getTimezoneOffset();
      const local = new Date(d.getTime() - tz * 60000);
      return local.toISOString().slice(0,16);
    }
    function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  </script>
</body>
</html>
